YUI.add("moodle-atto_imagedragdrop-button",function(e,t){var n="atto_imagedragdrop",r='<img src="{{url}}" {{#if alt}}alt="{{alt}}" {{/if}} style="vertical-align:text-bottom;margin: 0 .5em;" class="img-responsive" {{#if presentation}}role="presentation" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_imagedragdrop").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){var t=this,i=this.get("host"),s=e.Handlebars.compile(r);this.editor.on("drop",function(r){i.saveSelection(),r=r._event;if(r.dataTransfer&&r.dataTransfer.files&&r.dataTransfer.files.length&&/^image\//.test(r.dataTransfer.files[0].type)){r.preventDefault(),r.stopPropagation();var o=i.get("filepickeroptions").image,u=o.savepath===undefined?"/":o.savepath,a=new FormData;a.append("repo_upload_file",r.dataTransfer.files[0]),a.append("itemid",o.itemid);var f=Object.keys(o.repositories);for(var l=0;l<f.length;l++)if(o.repositories[f[l]].type==="upload"){a.append("repo_id",o.repositories[f[l]].id);break}a.append("env",o.env),a.append("sesskey",M.cfg.sesskey),a.append("client_id",o.client_id),a.append("savepath",u),a.append("ctx_id",o.context.id);var c=(new Date).getTime(),h="moodleimage_"+Math.round(Math.random()*1e5)+"-"+c;i.focus(),i.restoreSelection();var p=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:h});i.insertContentAtFocusPoint(p),t.markUpdated();var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(d.readyState===4){var n=t.editor.one("#"+h);if(d.status===200){var r=JSON.parse(d.responseText);if(r){if(r.error)return n&&n.remove(!0),new M.core.ajaxException(r);var i=r;r.event&&r.event==="fileexists"&&(i=r.newfile);var o=s({url:i.url,presentation:!0}),u=e.Node.create(o);n?n.replace(u):t.editor.appendChild(u),t.markUpdated()}}else alert(M.util.get_string("servererror","moodle")),n&&n.remove(!0)}},d.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),d.send(a),!1}},this)}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
